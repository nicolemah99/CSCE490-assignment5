{% extends "auctions/layout.html" %}

<script>
    document.addEventListener("DOMContentLoaded", ()=> {
        document.querySelector("#watchlist1").onclick = () => {
            const id = document.querySelect('#watchlist1').getAttribute('data-id')
            fetch(`api/watchlistToggle/${id}`).then(response => {return response.json()}).then(data => {
                console.log(data);
                updateImage(data);
            })
        }
    })

    function updateImage(data){
        newstate = data["current_value"];
        filename = `/auctions/static/auctions/${newstate}.png`;
        document.querySelect('#watchlist1').src = filename;
    }

</script>

{% block main %}
<a href="{% url 'index' %}">Back to all listings</a><br><br>
<article>
    <section style="display:inline-flexbox">
        {% if owner %}
            <h4>You own this item.</h4>
            <form method="POST" action="{% url 'closeBidding' item.id %}">
                {% csrf_token %}
                <button>Close Bidding</button>
            </form>
        {% endif %}
        <h2>{{ item.name }}</h2>

        {% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
                {% endfor %}
        </ul>
        {% endif %}

        <span class="material-symbols-outlined" id="watchlist" style="font-variation-settings:'FILL' 0">favorite</span>
        <img src="/auctions/static/auctions/no.png" id="watchlist1" alt="Unfilled heart Icon" data-id="{{item.id}}" style="width:60px">

        {% if user.is_authenticated %}
        {% if inWatchlist %}
        <form method="POST" action="{% url 'removefromwatchlist' item.id %}">
            {% csrf_token %}
            <button>Remove from watchlist</button>
        </form>
        {% else %}

        <form method="POST" action="{% url 'addtowatchlist' item.id %}">
            {% csrf_token %}
            <button>Add to watchlist</button>
        </form>

        {% endif %}
        {% endif %}
    </section>
    <section>
        <img src="{{ item.image.url }}" style="width:500px">
    </section>

    <section>
        {% if winning %}
            <h3>You are winning this bid.</h3>
        {% endif %}
        <h3>${{ item.currentBid }}</h3>
        <h4>Bidding ends: {{ item.dateBidEnd }} </h4>

        {% if user.is_authenticated %}
        <form method="POST" action="{% url 'bid' item.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            {{ bidForm }}
            <button>Bid</button>
        </form>
        {% else %}
            <a href="{% url 'login' %}">Login</a><p style="display:inline"> to bid on this item</p>
        {% endif %}
        

        <h4>Description</h4>
        <p>{{ item.description }}</p>
        <h4>Details</h4>
        <ul>
            <li>Listed by: {{ item.user }}</li>
            <li>Category: {{ item.category }}</li>
        </ul>
    </section>

    <section>
        <h4>Comments</h4>
        <article>
            {% for c in allComments %}
            <section> "{{ c.comment }}" <br>by <strong>{{ c.user }}</strong> on {{ c.date }}</section>
            {% endfor %}
        </article>

            {% if user.is_authenticated %}
        <form method="POST" action="{% url 'comment' item.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type='hidden' name='listing_id' value='{{ item.id }}' />
            {{ commentForm }}
            <button style="display:block">Comment</button>
        </form>
        {% else %}
        <a href="{% url 'login' %}">Login</a><p style="display:inline"> to comment on this item</p>
        {% endif %}
        <script src="http://localhost/static/auctions/listing.js"></script>
    </section>

</article>

{% endblock %}