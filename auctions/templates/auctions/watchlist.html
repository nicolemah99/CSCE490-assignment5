{% extends "auctions/layout.html" %}

{% block main %}
<h2>Your Watchlist</h2>

<article>
    {% for l in watchlist%}
    <section>
        {% if user.is_authenticated %}
        <img src="/auctions/static/auctions/off.png" class="watchlist-icon" alt="Unfilled heart Icon" data-id="{{l.id}}"
            data-watchlist="True" style="cursor:pointer;width:60px;display:inline;">
            <br>
            <br>
        {% endif %}
        <a href="{% url 'listing' l.listing.id %}" style="text-decoration: none;">
            <img src="{{ l.listing.image.url }}" alt="{{ l.listing.name }}">
            <h3>{{ l.listing.name }}</h3>
            <h4>Current Bid: ${{ l.listing.currentBid }}</h4>
            <p>Posted: {{ l.listing.datePosted }}</p>
            <p>Posted by: {{ l.listing.user }}</p>
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'removefromwatchlist' l.listing.id %}">
                {% csrf_token %}
                <button class="btn btn-primary">Remove from watchlist</button>
            </form>
            {% endif %}
        </a>
        {% empty %}
        <h3>No listings on your Watchlist</h3>
        <a href="{% url 'index' %}">Find listings to add</a>
    </section>
    {% endfor %}

</article>
<script>
document.addEventListener("DOMContentLoaded", ()=> {
    lightbox()
    document.querySelectorAll('.watchlist-icon').forEach(icon => {
        var id = icon.dataset.id;
        icon.src = watchlist_check(icon.dataset.watchlist);
        icon.onclick = ()=> {
            fetch(`/api/watchlistToggle/${id}`).then(response => response.json()).then(data => {
                console.log(data);
                update_icon(data);
    
            })
        }
    })
    //const image = document.getElementById('watchlist');
    //const id = image.dataset.id;
    //image.src = watchlist_check(image.dataset.watchlist);

})

function lightbox(){
    const imageInstance = basicLightbox.create(document.querySelector('#image'))
    document.querySelector('img.image').onclick = imageInstance.show
}

function watchlist_check(inWatchlist){

    if (inWatchlist == 'True'){
        filename = '/auctions/static/auctions/on.png';
    }
    else{
        filename = '/auctions/static/auctions/off.png';
    }
    return filename
}

function update_icon(data){
    var newstate = data["current_value"];
    var filename = `/auctions/static/auctions/${newstate}.png`;
    document.getElementById('watchlist').src = filename;
}
</script>
{% endblock %}